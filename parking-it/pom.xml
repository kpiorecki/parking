<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<modelVersion>4.0.0</modelVersion>

	<parent>
		<groupId>com.kpiorecki.parking</groupId>
		<artifactId>parking-parent</artifactId>
		<version>1.0-SNAPSHOT</version>
	</parent>

	<artifactId>parking-it</artifactId>
	<packaging>pom</packaging>

	<profiles>
		<profile>
			<id>embedded</id>
			<properties>
				<unpacked-ear-dir>${project.build.directory}/unpacked-ear</unpacked-ear-dir>
				<greenmail-dir>${project.build.directory}/greenmail</greenmail-dir>
				<embedded-resources-dir>${basedir}/src/main/resources</embedded-resources-dir>
				<embedded-assembly-id>embedded</embedded-assembly-id>
			</properties>
			<dependencies>
				<dependency>
					<groupId>${project.groupId}</groupId>
					<artifactId>parking-ear</artifactId>
					<version>${project.version}</version>
					<type>ear</type>
				</dependency>
				<dependency>
					<groupId>com.icegreen</groupId>
					<artifactId>greenmail-webapp</artifactId>
					<type>war</type>
				</dependency>
			</dependencies>
			<build>
				<plugins>
					<plugin>
						<groupId>org.apache.maven.plugins</groupId>
						<artifactId>maven-dependency-plugin</artifactId>
						<executions>
							<!-- unpack ear dependency content into target directory -->
							<execution>
								<id>unpack-ear</id>
								<phase>generate-resources</phase>
								<goals>
									<goal>unpack</goal>
								</goals>
								<configuration>
									<artifactItems>
										<artifactItem>
											<groupId>${project.groupId}</groupId>
											<artifactId>parking-ear</artifactId>
											<version>${project.version}</version>
											<type>ear</type>
											<overWrite>true</overWrite>
											<outputDirectory>${unpacked-ear-dir}</outputDirectory>
										</artifactItem>
									</artifactItems>
								</configuration>
							</execution>

							<!-- copy greenmail dependency content into target directory -->
							<execution>
								<id>copy-greenmail</id>
								<phase>generate-resources</phase>
								<goals>
									<goal>copy</goal>
								</goals>
								<configuration>
									<artifactItems>
										<artifactItem>
											<groupId>com.icegreen</groupId>
											<artifactId>greenmail-webapp</artifactId>
											<version>${greenmail-version}</version>
											<type>war</type>
											<overWrite>true</overWrite>
											<outputDirectory>${greenmail-dir}</outputDirectory>
										</artifactItem>
									</artifactItems>
								</configuration>
							</execution>
						</executions>
					</plugin>

					<plugin>
						<groupId>org.codehaus.mojo</groupId>
						<artifactId>truezip-maven-plugin</artifactId>
						<executions>
							<!-- overwrite persistence.xml with its embedded version in ear's parking-ejb module jar -->
							<execution>
								<id>copy-persistence-xml</id>
								<phase>generate-resources</phase>
								<goals>
									<goal>copy</goal>
								</goals>
								<configuration>
									<fileset>
										<directory>${embedded-resources-dir}</directory>
										<includes>
											<include>persistence.xml</include>
										</includes>
										<outputDirectory>${unpacked-ear-dir}/parking-ejb-${project.version}.jar/META-INF</outputDirectory>
									</fileset>
								</configuration>
							</execution>
						</executions>
					</plugin>

					<plugin>
						<groupId>org.apache.maven.plugins</groupId>
						<artifactId>maven-assembly-plugin</artifactId>
						<executions>
							<!-- assemble embedded ear zip archive with overwritten persistence.xml and glassfish-resources.xml -->
							<execution>
								<id>make-assembly</id>
								<phase>package</phase>
								<goals>
									<goal>single</goal>
								</goals>
							</execution>
						</executions>
						<configuration>
							<descriptors>
								<descriptor>src/assembly/embedded.xml</descriptor>
							</descriptors>
						</configuration>
					</plugin>

					<plugin>
						<groupId>org.glassfish.embedded</groupId>
						<artifactId>maven-embedded-glassfish-plugin</artifactId>
						<configuration>
							<app>${project.build.directory}/${project.artifactId}-${project.version}-${embedded-assembly-id}.zip</app>
							<name>parking</name>
							<serverID>embedded</serverID>
							<autoDelete>true</autoDelete>
							<ports>
								<http-listener>8080</http-listener>
								<https-listener>8181</https-listener>
							</ports>
						</configuration>
						<executions>
							<!-- start embedded glassfish server -->
							<execution>
								<id>start-server</id>
								<phase>pre-integration-test</phase>
								<goals>
									<goal>start</goal>
								</goals>
							</execution>

							<!-- deploy greenmail (goal specific configuration) -->
							<execution>
								<id>deploy-greenmail</id>
								<phase>pre-integration-test</phase>
								<goals>
									<goal>deploy</goal>
								</goals>
								<configuration>
									<app>${greenmail-dir}/greenmail-webapp-${greenmail-version}.war</app>
									<name>greenmail</name>
									<contextRoot>greenmail</contextRoot>
									<deploymentParams>
										<param>--verify=true</param>
									</deploymentParams>
								</configuration>
							</execution>

							<!-- deploy parking (plugin level configuration), will be automatically undeployed when finished -->
							<execution>
								<id>run-parking</id>
								<phase>integration-test</phase>
								<goals>
									<goal>run</goal>
								</goals>
							</execution>

							<!-- undeploy greenmail webapp -->
							<execution>
								<id>undeploy-greenmail</id>
								<phase>post-integration-test</phase>
								<goals>
									<goal>undeploy</goal>
								</goals>
								<configuration>
									<name>greenmail</name>
								</configuration>
							</execution>

							<!-- stop embedded glassfish server -->
							<execution>
								<id>stop-server</id>
								<phase>post-integration-test</phase>
								<goals>
									<goal>stop</goal>
								</goals>
							</execution>
						</executions>
					</plugin>
				</plugins>
			</build>
		</profile>
	</profiles>

</project>